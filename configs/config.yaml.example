# @package _global_

# This is the main Hydra configuration file.
# It defines the default experiment setup. sdfs

defaults:
  - _self_
  - data: default_features
  - model: mlp_visual 
  - override hydra/job_logging: default
  - override hydra/hydra_logging: default
  

# Defines the manifest filenames for each data split
# These files are expected inside 'paths.manifest_dir'
data:
  train_manifest: "train.csv"
  val_manifest: "valid.csv"
  auto_split:
    enabled: false
    val_fraction: 0.1
    stratify: true
    seed: null
  # A list of test manifests to evaluate on
  test_manifests:
    - "test_manual_all.csv"
    - "test_manual_train.csv"
    - "test_manual_valid.csv"

# Paths and filesystem layout for data, manifests, and run outputs.
paths:
  # ====DATA PATHS====
  # Root directory that contains feature files used by the datasets.
  data_root: "data/features/CT-CLIP_v2"
  # Directory that stores train/val/test manifest CSVs.
  manifest_dir: "data/manifests"

  # ====OUTPUT PATHS====
  # Base folder where all experiments are recorded.
  outputs_root: "outputs"
  # Job-level folder (one per experiment name) for history and resume metadata.
  job_base_dir: "${paths.outputs_root}/${hydra:job.name}"
  # Run-specific folder (one per execution) mirrors Hydra's working directory.
  run_dir: "${hydra:run.dir}"
  # Alias maintained for backwards compatibility with existing code/tests.
  output_dir: "${paths.run_dir}"
  # Where checkpoints are stored inside the run directory.
  checkpoint_dir: "${paths.output_dir}/checkpoints/"
  # Pointer file updated after each run to simplify resume/evaluation.
  latest_run_pointer: "${paths.job_base_dir}/latest_run.json"
  # Optional direct checkpoint override (None by default for Hydra struct typing).
  checkpoint_path: null

# Hydra runtime settings control where each run writes logs/config snapshots.
hydra:
  run:
    # Place each run inside the job-named folder with a timestamped leaf.
    dir: "${paths.job_base_dir}/${now:%Y-%m-%d_%H-%M-%S}"
  # Keep Hydra metadata together under a lightweight subfolder.
  output_subdir: ".hydra"


# Defines training and evaluation parameters.
training:
  batch_size: 64
  num_workers: 0 # Recommended to be 0
  learning_rate: 1e-4
  weight_decay: 0.0
  max_epochs: 5000
  early_stopping_patience: 15
  resume:
    enabled: false
    state_path: null
  
  # Parameters for classification tasks
  task_type: "classification"
  
  # Loss function configuration
  loss:
    _target_: "torch.nn.BCEWithLogitsLoss"  
  
  # Based on CT-RATE 
  target_labels: [
    # "Medical material",
    "Arterial wall calcification",
    # "Cardiomegaly",
    # "Pericardial effusion",
    # "Coronary artery wall calcification",
    # "Hiatal hernia",
    "Lymphadenopathy",
    # "Emphysema",
    # "Atelectasis",
    "Lung nodule",
    "Lung opacity",
    "Pulmonary fibrotic sequela",
    # "Pleural effusion",
    # "Mosaic attenuation pattern",
    # "Peribronchial thickening",
    # "Consolidation",
    # "Bronchiectasis",
    # "Interlobular septal thickening",
  ]

# Utility and reproducibility configuration
utils:
  seed: 42

# Analysis configuration (for analyze_alignment.py script)
analysis:
  filter_normal_cases: false  # Set to true to exclude cases with all labels = 0

# Configuration for experiment tracking (e.g., W&B, TensorBoard)
logging:
  logger_name: "wandb" 
  project_name: "ct-rate-feature-benchmarks"
  entity: null
  group: null
  run_name: null
  job_type: null
  tags: []
  log_model: false # (e.g., "all", "false")
  watch:
    log: null # Override to "gradients" or "all" to control wandb.watch
    log_freq: 100